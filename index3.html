// Google Apps Script 程式碼
// 請複製此程式碼到 Google Apps Script 編輯器中

function doPost(e) {
  try {
    // 解析接收到的資料
    const data = JSON.parse(e.postData.contents);
    
    // 開啟指定的 Google Sheets
    const spreadsheetId = '1I4bK8dxjdChiov2pSbD2t9PejT9PlRS00CVGrJJGxyE';
    const spreadsheet = SpreadsheetApp.openById(spreadsheetId);
    
    // 取得「定位」工作表
    let sheet = spreadsheet.getSheetByName('定位');
    
    // 如果「定位」工作表不存在，則建立它
    if (!sheet) {
      sheet = spreadsheet.insertSheet('定位');
      
      // 設定表頭
      const headers = ['時間', 'LINE ID', '緯度', '經度', '地址', '學號', '姓名', '學校', '宿舍樓棟', '房號', '距離(m)', '狀態'];
      sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
      
      // 格式化表頭
      const headerRange = sheet.getRange(1, 1, 1, headers.length);
      headerRange.setBackground('#4285f4');
      headerRange.setFontColor('white');
      headerRange.setFontWeight('bold');
      headerRange.setHorizontalAlignment('center');
    }
    
    // 準備要寫入的資料
    const rowData = [
      data.timestamp || new Date().toISOString(),
      data.lineId || '',
      data.latitude || '',
      data.longitude || '',
      data.address || '',
      data.userId || '',
      data.userName || '',
      data.dormSchool || '',
      data.dormBuilding || '',
      data.roomNumber || '',
      data.distance || '',
      data.status || ''
    ];
    
    // 在最後一行新增資料
    sheet.appendRow(rowData);
    
    // 格式化新增的行
    const lastRow = sheet.getLastRow();
    const range = sheet.getRange(lastRow, 1, 1, rowData.length);
    
    // 根據狀態設定行的顏色
    if (data.status === 'success') {
      range.setBackground('#d4edda'); // 成功：淺綠色
    } else if (data.status === 'failed') {
      range.setBackground('#f8d7da'); // 失敗：淺紅色
    }
    
    // 設定時間格式
    if (rowData[0]) {
      sheet.getRange(lastRow, 1).setNumberFormat('yyyy-mm-dd hh:mm:ss');
    }
    
    // 設定座標格式
    sheet.getRange(lastRow, 3).setNumberFormat('0.000000'); // 緯度
    sheet.getRange(lastRow, 4).setNumberFormat('0.000000'); // 經度
    
    // 自動調整欄寬
    sheet.autoResizeColumns(1, rowData.length);
    
    return ContentService
      .createTextOutput(JSON.stringify({
        success: true,
        message: '資料已成功寫入 Google Sheets',
        row: lastRow
      }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    console.error('錯誤:', error);
    
    return ContentService
      .createTextOutput(JSON.stringify({
        success: false,
        message: '寫入失敗: ' + error.message
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  // 處理 GET 請求（測試用）
  return ContentService
    .createTextOutput('Google Apps Script 已就緒，可接收 POST 請求')
    .setMimeType(ContentService.MimeType.TEXT);
}

// 測試函數
function testFunction() {
  const testData = {
    timestamp: new Date().toISOString(),
    lineId: 'test123',
    latitude: 25.0330,
    longitude: 121.5654,
    address: '台北市信義區',
    userId: 'A123456789',
    userName: '測試學生',
    dormSchool: '測試學校',
    dormBuilding: 'A棟',
    roomNumber: '101',
    distance: 50,
    status: 'success'
  };
  
  // 模擬 POST 請求
  const e = {
    postData: {
      contents: JSON.stringify(testData)
    }
  };
  
  const result = doPost(e);
  console.log(result.getContent());
}
