<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LINE LIFF å®šä½æ‰“å¡</title>
  <style>
    :root{--bg:#0b1220;--card:#111a2b;--ink:#e6edf3;--muted:#9fb3c8;--ok:#38bdf8;--warn:#f59e0b;--err:#ef4444;--accent:#22c55e}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif}
    .wrap{max-width:860px;margin:auto;padding:20px}
    .card{background:linear-gradient(180deg,#0f1629 0,#0b1220 100%);border:1px solid #1f2a44;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:20px}
    h1{font-size:22px;margin:0 0 16px;display:flex;align-items:center;gap:8px}
    h1 .dot{width:10px;height:10px;border-radius:50%;background:var(--warn);display:inline-block}
    .grid{display:grid;gap:12px}
    @media(min-width:720px){.grid{grid-template-columns:1fr 1fr}}
    label{font-weight:600;font-size:14px;color:var(--muted)} input,select,textarea{width:100%;padding:12px 14px;border:1px solid #243353;background:#0b1424;color:var(--ink);border-radius:10px;outline:none}
    .row{display:flex;gap:10px;align-items:center}
    button{cursor:pointer;border:1px solid #243353;background:#0b1424;color:var(--ink);padding:12px 14px;border-radius:12px}
    button.primary{background:linear-gradient(90deg,#2563eb,#06b6d4);border:none}
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:12px 0}
    .kpi div{background:rgba(255,255,255,.04);border:1px solid #1f2a44;border-radius:12px;padding:10px 12px}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .badge{display:inline-flex;align-items:center;gap:6px;background:#101a2b;border:1px solid #1f2a44;padding:6px 8px;border-radius:999px;color:var(--muted);font-size:12px}
    .hint{color:var(--muted);font-size:13px}
    .ok{color:var(--accent)} .err{color:var(--err)} .warn{color:var(--warn)}
    .footer{display:flex;gap:8px;flex-wrap:wrap;margin-top:16px}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ğŸ“ LIFF å®šä½æ‰“å¡ <span id="envBadge" class="badge">åˆå§‹åŒ–ä¸­â€¦</span></h1>
      <div class="grid">
        <div>
          <label>å­¸è™Ÿï¼ˆè‡ªå‹•å¸¶å…¥ / å¯æ‰‹å¡«ï¼‰</label>
          <input id="studentId" placeholder="ä¾‹å¦‚ï¼šA1234567" />
        </div>
        <div>
          <label>å§“åï¼ˆå¯é¸ï¼‰</label>
          <input id="studentName" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜" />
        </div>
      </div>

      <div class="grid" style="margin-top:8px">
        <div>
          <label>å‹•ä½œ</label>
          <select id="action">
            <option value="å›å®¿èˆ">å›å®¿èˆ</option>
            <option value="é›¢é–‹å®¿èˆ">é›¢é–‹å®¿èˆ</option>
          </select>
        </div>
        <div>
          <label>å®¿èˆ</label>
          <select id="dorm">
            <option value="å•Ÿè‹±">å•Ÿè‹±</option>
            <option value="è¬èƒ½">è¬èƒ½</option>
            <option value="æ²»å¹³">æ²»å¹³</option>
          </select>
        </div>
      </div>

      <div class="kpi">
        <div><div class="hint">ç·¯åº¦</div><div id="lat" class="mono">â€”</div></div>
        <div><div class="hint">ç¶“åº¦</div><div id="lng" class="mono">â€”</div></div>
        <div><div class="hint">ç²¾æº–åº¦(m)</div><div id="acc" class="mono">â€”</div></div>
        <div><div class="hint">æ™‚é–“</div><div id="ts" class="mono">â€”</div></div>
      </div>

      <div class="grid">
        <div>
          <label>å‚™è¨»ï¼ˆå¯é¸ï¼‰</label>
          <textarea id="note" rows="3" placeholder="ä¾‹ï¼šè‡¨æ™‚è¿”å®¿ã€ç¤¾åœ˜æ´»å‹•æ™šæ­¸â€¦"></textarea>
          <div class="small">è‹¥å®šä½æ¬Šé™è¢«æ‹’ï¼Œå¯æ”¹ç”¨ LINE ä½ç½®è¨Šæ¯ï¼š<a href="line://nv/location" class="small" style="color:#93c5fd">é–‹å•Ÿä½ç½®å‚³é€</a></div>
        </div>
        <div>
          <label>é€å‡ºç‹€æ…‹</label>
          <div id="status" class="small">å°šæœªé€å‡º</div>
          <div class="footer">
            <button id="btnLocate">ğŸ“¡ é‡æ–°å®šä½</button>
            <button id="btnSubmit" class="primary">âœ… é€å‡ºæ‰“å¡</button>
            <button id="btnClose">âœ–ï¸ é—œé–‰</button>
          </div>
        </div>
      </div>

      <div class="small" style="margin-top:8px">
        è¨­å®šæŒ‡å¼•ï¼šå°‡ <code class="mono">LIFF_ID</code> èˆ‡ <code class="mono">ENDPOINT_URL</code> æ”¹æˆä½ çš„å€¼ã€‚é è¨­ä»¥ GAS Web App æ”¶è³‡æ–™ã€‚è‹¥è¦é€ Google è¡¨å–®ï¼Œè«‹æ”¹ç”¨ <code>submitToGoogleForm</code>ï¼Œä¸¦å¡«å…¥å°æ‡‰çš„ entry æ¬„ä½ IDã€‚
      </div>
    </div>
  </div>

  <!-- LINE LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    /***********************
     * ğŸ”§ å¯èª¿æ•´åƒæ•¸ï¼ˆå¿…æ”¹ï¼‰
     ***********************/
    const LIFF_ID = "2007799936-ALLRexOO"; // ä¾‹ï¼š165xxxx-xxxxx
    const ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbwMcZCUkthNlA2qbSsNUXhApKzZhm5R8vh0rfsGM0j0YGn4vxfBvQhMzRzTijADLcTz/exec"; // ä½ çš„ GAS Web Appï¼ˆPOST JSONï¼‰

    // â›³ è‹¥ä½ å·²è®“ BOT åœ¨é–‹å•Ÿ LIFF å‰é™„å¸¶å­¸è™Ÿï¼Œå¯ç”¨ ?studentId=xxx è‡ªå‹•å¸¶å…¥
    //    æˆ–æ˜¯å¾ localStorage è®€å–ä¸Šæ¬¡è¼¸å…¥çš„å­¸è™Ÿ

    /***********************
     * ç‹€æ…‹ç®¡ç†
     ***********************/
    let latestGeo = null;

    function qs(id){return document.getElementById(id)}
    function setStatus(html, klass){
      const el = qs('status');
      el.className = `small ${klass||''}`;
      el.innerHTML = html;
    }

    function fmtTs(t){
      const d = new Date(t);
      const pad = n=>String(n).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`
    }

    /***********************
     * LIFF åˆå§‹åŒ–
     ***********************/
    async function initLiff(){
      try{
        await liff.init({ liffId: LIFF_ID });
        qs('envBadge').textContent = `LIFF å·²è¼‰å…¥ / ${liff.isInClient() ? 'LINE å…§' : 'ç€è¦½å™¨'}`;
        if(!liff.isLoggedIn()){
          liff.login();
          return; // login å¾Œæœƒé‡è¼‰
        }
        // é å¡«å­¸è™Ÿï¼šquerystring > localStorage
        const params = new URLSearchParams(location.search);
        const qStu = params.get('studentId');
        const qName = params.get('name');
        if(qStu) { qs('studentId').value = qStu; localStorage.setItem('studentId', qStu) }
        if(qName){ qs('studentName').value = qName; localStorage.setItem('studentName', qName) }
        if(!qStu){ qs('studentId').value = localStorage.getItem('studentId') || '' }
        if(!qName){ qs('studentName').value = localStorage.getItem('studentName') || '' }

        // å–ç”¨æˆ¶è³‡æ–™ï¼ˆuserId å¯ç”¨æ–¼å¾Œç«¯æ¯”å°ç¶å®šï¼‰
        const prof = await liff.getProfile();
        window.__LINE_PROFILE__ = prof; // {userId, displayName, pictureUrl, statusMessage}
      }catch(err){
        setStatus(`LIFF åˆå§‹åŒ–å¤±æ•—ï¼š<span class='err'>${err.message}</span>`,`err`)
        console.error(err);
      }
    }

    /***********************
     * å–å¾—åœ°ç†ä½ç½®
     ***********************/
    function locate(){
      setStatus('å®šä½ä¸­â€¦ è«‹å…è¨±å­˜å–åœ°ç†ä½ç½®ã€‚', 'warn');
      navigator.geolocation.getCurrentPosition(pos=>{
        const c = pos.coords;
        latestGeo = {
          lat: Number(c.latitude.toFixed(6)),
          lng: Number(c.longitude.toFixed(6)),
          acc: Math.round(c.accuracy),
          ts: Date.now()
        };
        qs('lat').textContent = latestGeo.lat;
        qs('lng').textContent = latestGeo.lng;
        qs('acc').textContent = latestGeo.acc;
        qs('ts').textContent = fmtTs(latestGeo.ts);
        setStatus('å®šä½å®Œæˆï¼Œå¯é€å‡ºã€‚','ok');
      }, err=>{
        setStatus(`å®šä½å¤±æ•—ï¼š<span class='err'>${err.message}</span>ã€‚è«‹é–‹å•Ÿå®šä½æˆ–æ”¹ç”¨ LINE ä½ç½®è¨Šæ¯ã€‚`,'err');
        console.error(err);
      }, { enableHighAccuracy:true, timeout:15000, maximumAge:0 });
    }

    /***********************
     * é€å‡ºè‡³ GASï¼ˆæ¨è–¦ï¼‰
     * å¾Œç«¯å¯ç›´æ¥å¯«å…¥ Google è©¦ç®—è¡¨
     ***********************/
    async function submitToGAS(){
      if(!latestGeo){ setStatus('å°šæœªå–å¾—å®šä½ï¼Œè«‹å…ˆé»ã€Œé‡æ–°å®šä½ã€ã€‚','warn'); return }
      const payload = {
        action: qs('action').value,
        dorm: qs('dorm').value,
        studentId: (qs('studentId').value||'').trim(),
        studentName: (qs('studentName').value||'').trim(),
        note: (qs('note').value||'').trim(),
        lat: latestGeo.lat,
        lng: latestGeo.lng,
        accuracy: latestGeo.acc,
        timestamp: latestGeo.ts,
        lineUserId: (window.__LINE_PROFILE__ && window.__LINE_PROFILE__.userId) || null,
        lineDisplayName: (window.__LINE_PROFILE__ && window.__LINE_PROFILE__.displayName) || null,
        userAgent: navigator.userAgent,
        source: 'liff'
      };

      // ä¿å­˜å­¸è™Ÿ/å§“åä»¥ä¾¿ä¸‹æ¬¡è‡ªå‹•å¸¶å…¥
      if(payload.studentId) localStorage.setItem('studentId', payload.studentId);
      if(payload.studentName) localStorage.setItem('studentName', payload.studentName);

      setStatus('å‚³é€ä¸­â€¦','warn');
      try{
        const res = await fetch(ENDPOINT_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const text = await res.text();
        if(!res.ok){ throw new Error(text || res.statusText) }
        setStatus('âœ… å·²é€å‡ºæˆåŠŸã€‚3 ç§’å¾Œè‡ªå‹•é—œé–‰ã€‚','ok');
        setTimeout(()=>{ try{ liff.closeWindow() }catch(_){} }, 3000);
      }catch(err){
        setStatus(`é€å‡ºå¤±æ•—ï¼š<span class='err'>${err.message}</span>`,'err');
        console.error(err);
      }
    }

    /***********************
     * é€å‡ºè‡³ Google è¡¨å–®ï¼ˆé¸ç”¨ï¼‰
     * æ³¨æ„ï¼šéœ€å°‡æ¬„ä½æ”¹æˆä½ çš„ entry.xxx ID
     ***********************/
    async function submitToGoogleForm(){
      // ğŸ” å°‡ä¸‹åˆ— entry æ¬„ä½æ”¹æˆä½ çš„ Google è¡¨å–®å°æ‡‰ ID
      const FORM_ACTION = "https://docs.google.com/forms/d/e/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx/formResponse";
      const ENTRY_STUDENT_ID = "entry.111111";
      const ENTRY_NAME       = "entry.222222";
      const ENTRY_DORM       = "entry.333333";
      const ENTRY_ACTION     = "entry.444444";
      const ENTRY_NOTE       = "entry.555555";
      const ENTRY_LOCATION   = "entry.666666"; // å¯åˆä½µç‚ºã€Œå®šä½è¨Šæ¯ã€

      if(!latestGeo){ setStatus('å°šæœªå–å¾—å®šä½ï¼Œè«‹å…ˆé»ã€Œé‡æ–°å®šä½ã€ã€‚','warn'); return }

      const form = new FormData();
      form.append(ENTRY_STUDENT_ID, (qs('studentId').value||'').trim());
      form.append(ENTRY_NAME, (qs('studentName').value||'').trim());
      form.append(ENTRY_DORM, qs('dorm').value);
      form.append(ENTRY_ACTION, qs('action').value);
      form.append(ENTRY_NOTE, (qs('note').value||'').trim());
      form.append(ENTRY_LOCATION, `lat:${latestGeo.lat}, lng:${latestGeo.lng}, acc:${latestGeo.acc}, ts:${fmtTs(latestGeo.ts)}`);

      setStatus('å‚³é€ä¸­â€¦','warn');
      try{
        const res = await fetch(FORM_ACTION, { method:'POST', mode:'no-cors', body: form });
        // no-cors ä¸‹ç„¡æ³•ç›´æ¥ç¢ºèªæˆåŠŸèˆ‡å¦ï¼Œè¦–ç‚ºé€å‡º
        setStatus('âœ… å·²é€å‡ºï¼ˆGoogle è¡¨å–®ï¼‰','ok');
        setTimeout(()=>{ try{ liff.closeWindow() }catch(_){} }, 3000);
      }catch(err){
        setStatus(`é€å‡ºå¤±æ•—ï¼š<span class='err'>${err.message}</span>`,'err');
        console.error(err);
      }
    }

    /***********************
     * äº‹ä»¶ç¶å®š
     ***********************/
    document.addEventListener('DOMContentLoaded', async ()=>{
      await initLiff();
      locate();
      qs('btnLocate').addEventListener('click', locate);
      qs('btnSubmit').addEventListener('click', submitToGAS); // é è¨­é€ GAS
      qs('btnClose').addEventListener('click', ()=>{ try{ liff.closeWindow() }catch(_){ window.close() } });
    });
  </script>
</body>
</html>
