
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¿èˆå®šä½æ‰“å¡ç®¡ç†ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: transparent;
            border: none;
            font-size: 16px;
        }

        .tab.active {
            background: white;
            color: #4facfe;
            font-weight: bold;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .content {
            padding: 30px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .checkin-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
        }

        .location-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .checkin-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .checkin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .checkin-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4facfe;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .record-item {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .record-item:hover {
            border-color: #4facfe;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .record-name {
            font-weight: bold;
            font-size: 18px;
            color: #333;
        }

        .record-time {
            color: #666;
            font-size: 14px;
        }

        .record-details {
            color: #888;
            font-size: 14px;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e1e5e9;
            border-radius: 25px;
            font-size: 16px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ  å®¿èˆå®šä½æ‰“å¡ç³»çµ±</h1>
            <p>æ™ºèƒ½åŒ–å®¿èˆç®¡ç†è§£æ±ºæ–¹æ¡ˆ</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showSection('checkin')">ğŸ“ æ‰“å¡</button>
            <button class="tab" onclick="showSection('records')">ğŸ“‹ è¨˜éŒ„</button>
            <button class="tab" onclick="showSection('manage')">âš™ï¸ ç®¡ç†</button>
            <button class="tab" onclick="showSection('stats')">ğŸ“Š çµ±è¨ˆ</button>
        </div>

        <div class="content">
            <!-- æ‰“å¡é é¢ -->
            <div id="checkin" class="section active">
                <div class="checkin-card">
                    <h2>ğŸ“ ä½ç½®æ‰“å¡</h2>
                    <div class="location-info">
                        <p><strong>ç›®å‰ä½ç½®ï¼š</strong><span id="currentLocation">æ­£åœ¨å®šä½ä¸­...</span></p>
                        <p><strong>å®¿èˆç¯„åœï¼š</strong><span id="dormRange">500å…¬å°ºå…§</span></p>
                    </div>
                    <button class="checkin-btn" id="checkinBtn" onclick="performCheckin()">
                        ğŸ¯ ç«‹å³æ‰“å¡
                    </button>
                    <p style="margin-top: 15px; font-size: 14px; opacity: 0.8;">
                        ç³»çµ±å°‡è‡ªå‹•é©—è­‰æ‚¨çš„ä½ç½®æ˜¯å¦åœ¨å®¿èˆç¯„åœå…§
                    </p>
                </div>

                <div class="form-group">
                    <label>å­¸è™Ÿ/å·¥è™Ÿ</label>
                    <input type="text" id="userId" placeholder="è«‹è¼¸å…¥å­¸è™Ÿæˆ–å·¥è™Ÿ">
                </div>

                <div class="form-group">
                    <label>å§“å</label>
                    <input type="text" id="userName" placeholder="è«‹è¼¸å…¥å§“å">
                </div>

                <div class="form-group">
                    <label>å­¸æ ¡/å®¿èˆ</label>
                    <select id="dormSchool" onchange="updateDormBuildings()">
                        <option value="">è«‹é¸æ“‡å­¸æ ¡</option>
                        <option value="å•Ÿè‹±é«˜ä¸­">å•Ÿè‹±é«˜ä¸­</option>
                        <option value="æ²»å¹³é«˜ä¸­">æ²»å¹³é«˜ä¸­</option>
                        <option value="è¬èƒ½ç§‘æŠ€å¤§å­¸">è¬èƒ½ç§‘æŠ€å¤§å­¸</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>å®¿èˆæ¨“æ£Ÿ</label>
                    <select id="dormBuilding">
                        <option value="">è«‹å…ˆé¸æ“‡å­¸æ ¡</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>æˆ¿è™Ÿ</label>
                    <input type="text" id="roomNumber" placeholder="è«‹è¼¸å…¥æˆ¿è™Ÿ">
                </div>
            </div>

            <!-- è¨˜éŒ„é é¢ -->
            <div id="records" class="section">
                <h2>ğŸ“‹ æ‰“å¡è¨˜éŒ„</h2>
                
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="ğŸ” æœå°‹å­¸è™Ÿã€å§“åæˆ–å®¿èˆ..." 
                           onkeyup="filterRecords()">
                </div>

                <div id="recordsList">
                    <!-- è¨˜éŒ„å°‡å‹•æ…‹è¼‰å…¥ -->
                </div>
            </div>

            <!-- ç®¡ç†é é¢ -->
            <div id="manage" class="section">
                <h2>âš™ï¸ ç³»çµ±ç®¡ç†</h2>
                
                <div class="form-group">
                    <label>é¸æ“‡å­¸æ ¡è¨­å®šåº§æ¨™</label>
                    <select id="schoolSelect" onchange="loadSchoolCoordinates()">
                        <option value="">è«‹é¸æ“‡å­¸æ ¡</option>
                        <option value="å•Ÿè‹±é«˜ä¸­">å•Ÿè‹±é«˜ä¸­</option>
                        <option value="æ²»å¹³é«˜ä¸­">æ²»å¹³é«˜ä¸­</option>
                        <option value="è¬èƒ½ç§‘æŠ€å¤§å­¸">è¬èƒ½ç§‘æŠ€å¤§å­¸</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>å®¿èˆä¸­å¿ƒåº§æ¨™</label>
                    <input type="text" id="dormCenterLat" placeholder="ç·¯åº¦" readonly>
                    <input type="text" id="dormCenterLng" placeholder="ç¶“åº¦" readonly style="margin-top: 10px;">
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">
                        â€» åº§æ¨™æœƒæ ¹æ“šé¸æ“‡çš„å­¸æ ¡è‡ªå‹•æ›´æ–°
                    </p>
                </div>

                <div class="form-group">
                    <label>å…è¨±æ‰“å¡ç¯„åœï¼ˆå…¬å°ºï¼‰</label>
                    <input type="number" id="allowedRange" value="500" min="100" max="2000">
                </div>

                <div class="form-group">
                    <label>æ‰“å¡æ™‚é–“é™åˆ¶</label>
                    <input type="time" id="checkinStart" value="18:00">
                    <label style="margin-top: 10px;">åˆ°</label>
                    <input type="time" id="checkinEnd" value="23:00">
                </div>

                <button class="btn" onclick="saveSettings()">ğŸ’¾ å„²å­˜è¨­å®š</button>
                <button class="btn" onclick="exportData()">ğŸ“¤ åŒ¯å‡ºè³‡æ–™</button>
                <button class="btn" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
            </div>

            <!-- çµ±è¨ˆé é¢ -->
            <div id="stats" class="section">
                <h2>ğŸ“Š çµ±è¨ˆåˆ†æ</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalCheckins">0</div>
                        <div class="stat-label">ç¸½æ‰“å¡æ¬¡æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="todayCheckins">0</div>
                        <div class="stat-label">ä»Šæ—¥æ‰“å¡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="successRate">0%</div>
                        <div class="stat-label">æˆåŠŸç‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeUsers">0</div>
                        <div class="stat-label">æ´»èºç”¨æˆ¶</div>
                    </div>
                </div>

                <div class="form-group">
                    <label>çµ±è¨ˆæ—¥æœŸç¯„åœ</label>
                    <input type="date" id="statsStartDate">
                    <input type="date" id="statsEndDate" style="margin-top: 10px;">
                    <button class="btn" onclick="generateStats()" style="margin-top: 10px;">ğŸ“ˆ ç”Ÿæˆçµ±è¨ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ç³»çµ±è¨­å®š - æ”¯æ´å¤šå€‹å®¿èˆåº§æ¨™
        let settings = {
            dormCenters: {
                "å•Ÿè‹±é«˜ä¸­": { lat: 25.9745716, lng: 121.2346071 },
                "æ²»å¹³é«˜ä¸­": { lat: 24.9163541, lng: 121.1885086 },
                "è¬èƒ½ç§‘æŠ€å¤§å­¸": { lat: 24.99257378, lng: 121.2301635 }
            },
            allowedRange: 500,
            checkinTimeStart: "18:00",
            checkinTimeEnd: "23:00"
        };

        // æ‰“å¡è¨˜éŒ„
        let checkinRecords = [];

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            loadRecords();
            updateStats();
            getCurrentLocation();
            
            // è¨­å®šä»Šå¤©çš„æ—¥æœŸç‚ºé è¨­å€¼
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('statsStartDate').value = today;
            document.getElementById('statsEndDate').value = today;
        });

        // æ ¹æ“šé¸æ“‡çš„å­¸æ ¡æ›´æ–°å®¿èˆæ¨“æ£Ÿé¸é …
        function updateDormBuildings() {
            const school = document.getElementById('dormSchool').value;
            const buildingSelect = document.getElementById('dormBuilding');
            
            // æ¸…ç©ºç¾æœ‰é¸é …
            buildingSelect.innerHTML = '';
            
            if (!school) {
                buildingSelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡å­¸æ ¡</option>';
                return;
            }
            
            // æ ¹æ“šå­¸æ ¡è¨­å®šä¸åŒçš„æ¨“æ£Ÿé¸é …
            const buildings = {
                "å•Ÿè‹±é«˜ä¸­": ["ç”·ç”Ÿå®¿èˆAæ£Ÿ", "ç”·ç”Ÿå®¿èˆBæ£Ÿ", "å¥³ç”Ÿå®¿èˆAæ£Ÿ", "å¥³ç”Ÿå®¿èˆBæ£Ÿ"],
                "æ²»å¹³é«˜ä¸­": ["å­¸ç”Ÿå®¿èˆ1æ£Ÿ", "å­¸ç”Ÿå®¿èˆ2æ£Ÿ", "å­¸ç”Ÿå®¿èˆ3æ£Ÿ"],
                "è¬èƒ½ç§‘æŠ€å¤§å­¸": ["Aæ£Ÿ", "Bæ£Ÿ", "Cæ£Ÿ", "Dæ£Ÿ", "Eæ£Ÿ", "Fæ£Ÿ"]
            };
            
            buildingSelect.innerHTML = '<option value="">è«‹é¸æ“‡å®¿èˆæ¨“æ£Ÿ</option>';
            
            if (buildings[school]) {
                buildings[school].forEach(building => {
                    const option = document.createElement('option');
                    option.value = building;
                    option.textContent = building;
                    buildingSelect.appendChild(option);
                });
            }
        }
        function showSection(sectionId) {
            // éš±è—æ‰€æœ‰é é¢
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ¨™ç±¤çš„ active ç‹€æ…‹
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // é¡¯ç¤ºé¸ä¸­çš„é é¢
            document.getElementById(sectionId).classList.add('active');
            
            // æ·»åŠ é¸ä¸­æ¨™ç±¤çš„ active ç‹€æ…‹
            event.target.classList.add('active');
        }

        // ç²å–ç›®å‰ä½ç½®
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        document.getElementById('currentLocation').textContent = 
                            `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                        
                        // æª¢æŸ¥æ‰€æœ‰å­¸æ ¡çš„è·é›¢
                        checkAllSchoolDistances(lat, lng);
                    },
                    function(error) {
                        document.getElementById('currentLocation').textContent = 'å®šä½å¤±æ•—';
                        console.error('å®šä½éŒ¯èª¤:', error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            } else {
                document.getElementById('currentLocation').textContent = 'ä¸æ”¯æ´å®šä½åŠŸèƒ½';
            }
        }

        // æª¢æŸ¥æ‰€æœ‰å­¸æ ¡çš„è·é›¢
        function checkAllSchoolDistances(userLat, userLng) {
            let closestSchool = null;
            let closestDistance = Infinity;
            let withinRange = false;

            // æª¢æŸ¥æ¯å€‹å­¸æ ¡çš„è·é›¢
            for (const [schoolName, coords] of Object.entries(settings.dormCenters)) {
                const distance = calculateDistance(userLat, userLng, coords.lat, coords.lng);
                
                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestSchool = schoolName;
                }
                
                if (distance <= settings.allowedRange) {
                    withinRange = true;
                }
            }

            // æ›´æ–°é¡¯ç¤ºè³‡è¨Š
            const rangeText = withinRange ? 
                `âœ… åœ¨ ${closestSchool} ç¯„åœå…§ (${Math.round(closestDistance)}m)` : 
                `âŒ æœ€è¿‘çš„å­¸æ ¡: ${closestSchool} (${Math.round(closestDistance)}m)`;
            
            document.getElementById('dormRange').textContent = rangeText;
            
            // æ›´æ–°æ‰“å¡æŒ‰éˆ•ç‹€æ…‹
            const checkinBtn = document.getElementById('checkinBtn');
            if (!withinRange) {
                checkinBtn.disabled = true;
                checkinBtn.textContent = 'âŒ ä¸åœ¨ä»»ä½•å®¿èˆç¯„åœå…§';
            } else {
                checkinBtn.disabled = false;
                checkinBtn.textContent = 'ğŸ¯ ç«‹å³æ‰“å¡';
                
                // è‡ªå‹•é¸æ“‡æœ€è¿‘çš„å­¸æ ¡
                if (closestDistance <= settings.allowedRange) {
                    document.getElementById('dormSchool').value = closestSchool;
                    updateDormBuildings();
                }
            }
        }

        // è¨ˆç®—å…©é»é–“è·é›¢
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000; // åœ°çƒåŠå¾‘ï¼ˆå…¬å°ºï¼‰
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // åŸ·è¡Œæ‰“å¡
        function performCheckin() {
            const userId = document.getElementById('userId').value;
            const userName = document.getElementById('userName').value;
            const dormSchool = document.getElementById('dormSchool').value;
            const dormBuilding = document.getElementById('dormBuilding').value;
            const roomNumber = document.getElementById('roomNumber').value;

            if (!userId || !userName || !dormSchool || !dormBuilding || !roomNumber) {
                alert('è«‹å¡«å¯«å®Œæ•´è³‡æ–™ï¼');
                return;
            }

            // æª¢æŸ¥æ™‚é–“é™åˆ¶
            const now = new Date();
            const currentTime = now.getHours().toString().padStart(2, '0') + ':' + 
                              now.getMinutes().toString().padStart(2, '0');
            
            if (currentTime < settings.checkinTimeStart || currentTime > settings.checkinTimeEnd) {
                alert(`æ‰“å¡æ™‚é–“é™åˆ¶ï¼š${settings.checkinTimeStart} - ${settings.checkinTimeEnd}`);
                return;
            }

            // ç²å–ç•¶å‰ä½ç½®ä¸¦åŸ·è¡Œæ‰“å¡
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // æª¢æŸ¥æ˜¯å¦åœ¨é¸æ“‡çš„å­¸æ ¡ç¯„åœå…§
                    const schoolCoords = settings.dormCenters[dormSchool];
                    const distance = calculateDistance(lat, lng, schoolCoords.lat, schoolCoords.lng);

                    const record = {
                        id: Date.now(),
                        userId: userId,
                        userName: userName,
                        dormSchool: dormSchool,
                        dormBuilding: dormBuilding,
                        roomNumber: roomNumber,
                        latitude: lat,
                        longitude: lng,
                        distance: Math.round(distance),
                        timestamp: new Date().toISOString(),
                        status: distance <= settings.allowedRange ? 'success' : 'failed'
                    };

                    checkinRecords.push(record);
                    saveRecords();
                    
                    if (record.status === 'success') {
                        alert(`âœ… ${dormSchool} æ‰“å¡æˆåŠŸï¼`);
                    } else {
                        alert(`âŒ æ‰“å¡å¤±æ•—ï¼šä¸åœ¨ ${dormSchool} å®¿èˆç¯„åœå…§`);
                    }
                    
                    displayRecords();
                    updateStats();
                });
            }
        }

        // é¡¯ç¤ºæ‰“å¡è¨˜éŒ„
        function displayRecords() {
            const recordsList = document.getElementById('recordsList');
            if (checkinRecords.length === 0) {
                recordsList.innerHTML = '<p style="text-align: center; color: #666;">æš«ç„¡æ‰“å¡è¨˜éŒ„</p>';
                return;
            }

            const html = checkinRecords
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .map(record => {
                    const date = new Date(record.timestamp);
                    const statusClass = record.status === 'success' ? 'status-success' : 'status-error';
                    const statusText = record.status === 'success' ? 'æˆåŠŸ' : 'å¤±æ•—';
                    
                    return `
                        <div class="record-item">
                            <div class="record-header">
                                <div class="record-name">${record.userName} (${record.userId})</div>
                                <div class="status-badge ${statusClass}">${statusText}</div>
                            </div>
                            <div class="record-details">
                                ğŸ« ${record.dormSchool} ${record.dormBuilding} ${record.roomNumber}æˆ¿ | 
                                ğŸ“ è·é›¢: ${record.distance}m | 
                                ğŸ• ${date.toLocaleString('zh-TW')}
                            </div>
                        </div>
                    `;
                }).join('');

            recordsList.innerHTML = html;
        }

        // ç¯©é¸è¨˜éŒ„
        function filterRecords() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filteredRecords = checkinRecords.filter(record => 
                record.userId.toLowerCase().includes(searchTerm) ||
                record.userName.toLowerCase().includes(searchTerm) ||
                record.dormSchool.toLowerCase().includes(searchTerm) ||
                record.dormBuilding.toLowerCase().includes(searchTerm) ||
                record.roomNumber.toLowerCase().includes(searchTerm)
            );

            const recordsList = document.getElementById('recordsList');
            if (filteredRecords.length === 0) {
                recordsList.innerHTML = '<p style="text-align: center; color: #666;">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„</p>';
                return;
            }

            const html = filteredRecords
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .map(record => {
                    const date = new Date(record.timestamp);
                    const statusClass = record.status === 'success' ? 'status-success' : 'status-error';
                    const statusText = record.status === 'success' ? 'æˆåŠŸ' : 'å¤±æ•—';
                    
                    return `
                        <div class="record-item">
                            <div class="record-header">
                                <div class="record-name">${record.userName} (${record.userId})</div>
                                <div class="status-badge ${statusClass}">${statusText}</div>
                            </div>
                            <div class="record-details">
                                ğŸ« ${record.dormSchool} ${record.dormBuilding} ${record.roomNumber}æˆ¿ | 
                                ğŸ“ è·é›¢: ${record.distance}m | 
                                ğŸ• ${date.toLocaleString('zh-TW')}
                            </div>
                        </div>
                    `;
                }).join('');

            recordsList.innerHTML = html;
        }

        // æ›´æ–°çµ±è¨ˆè³‡æ–™
        function updateStats() {
            const total = checkinRecords.length;
            const today = new Date().toDateString();
            const todayCount = checkinRecords.filter(record => 
                new Date(record.timestamp).toDateString() === today
            ).length;
            const successCount = checkinRecords.filter(record => record.status === 'success').length;
            const successRate = total > 0 ? Math.round((successCount / total) * 100) : 0;
            const activeUsers = new Set(checkinRecords.map(record => record.userId)).size;

            document.getElementById('totalCheckins').textContent = total;
            document.getElementById('todayCheckins').textContent = todayCount;
            document.getElementById('successRate').textContent = successRate + '%';
            document.getElementById('activeUsers').textContent = activeUsers;
        }

        // å„²å­˜è¨­å®š
        function saveSettings() {
            const selectedSchool = document.getElementById('schoolSelect').value;
            
            if (!selectedSchool) {
                alert('è«‹å…ˆé¸æ“‡è¦è¨­å®šçš„å­¸æ ¡ï¼');
                return;
            }
            
            const lat = parseFloat(document.getElementById('dormCenterLat').value);
            const lng = parseFloat(document.getElementById('dormCenterLng').value);
            
            if (isNaN(lat) || isNaN(lng)) {
                alert('åº§æ¨™æ ¼å¼éŒ¯èª¤ï¼');
                return;
            }
            
            // æ›´æ–°é¸ä¸­å­¸æ ¡çš„åº§æ¨™
            settings.dormCenters[selectedSchool] = { lat: lat, lng: lng };
            settings.allowedRange = parseInt(document.getElementById('allowedRange').value);
            settings.checkinTimeStart = document.getElementById('checkinStart').value;
            settings.checkinTimeEnd = document.getElementById('checkinEnd').value;

            alert(`âœ… ${selectedSchool} çš„è¨­å®šå·²å„²å­˜ï¼`);
            getCurrentLocation(); // é‡æ–°æª¢æŸ¥ä½ç½®
        }

        // åŒ¯å‡ºè³‡æ–™
        function exportData() {
            const dataStr = JSON.stringify({
                settings: settings,
                records: checkinRecords,
                exportTime: new Date().toISOString()
            }, null, 2);
            
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `å®¿èˆæ‰“å¡è³‡æ–™_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
        }

        // æ¸…é™¤æ‰€æœ‰è³‡æ–™
        function clearAllData() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ‰“å¡è¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ¢å¾©ï¼')) {
                checkinRecords = [];
                displayRecords();
                updateStats();
                alert('âœ… æ‰€æœ‰è³‡æ–™å·²æ¸…é™¤ï¼');
            }
        }

        // ç”Ÿæˆçµ±è¨ˆå ±å‘Š
        function generateStats() {
            const startDate = new Date(document.getElementById('statsStartDate').value);
            const endDate = new Date(document.getElementById('statsEndDate').value);
            
            if (startDate > endDate) {
                alert('é–‹å§‹æ—¥æœŸä¸èƒ½å¤§æ–¼çµæŸæ—¥æœŸï¼');
                return;
            }

            const filteredRecords = checkinRecords.filter(record => {
                const recordDate = new Date(record.timestamp);
                return recordDate >= startDate && recordDate <= endDate;
            });

            const stats = {
                total: filteredRecords.length,
                success: filteredRecords.filter(r => r.status === 'success').length,
                failed: filteredRecords.filter(r => r.status === 'failed').length,
                users: new Set(filteredRecords.map(r => r.userId)).size
            };

            alert(`ğŸ“Š çµ±è¨ˆçµæœï¼ˆ${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}ï¼‰ï¼š
ç¸½æ‰“å¡æ¬¡æ•¸ï¼š${stats.total}
æˆåŠŸæ¬¡æ•¸ï¼š${stats.success}
å¤±æ•—æ¬¡æ•¸ï¼š${stats.failed}
åƒèˆ‡ç”¨æˆ¶ï¼š${stats.users}äºº
æˆåŠŸç‡ï¼š${stats.total > 0 ? Math.round((stats.success / stats.total) * 100) : 0}%`);
        }

        // è¼‰å…¥è¨­å®šï¼ˆå¾è¨˜æ†¶é«”ï¼‰
        function loadSettings() {
            // é è¨­è¼‰å…¥ç¬¬ä¸€å€‹å­¸æ ¡çš„åº§æ¨™
            const firstSchool = Object.keys(settings.dormCenters)[0];
            if (firstSchool) {
                document.getElementById('schoolSelect').value = firstSchool;
                loadSchoolCoordinates();
            }
            
            document.getElementById('allowedRange').value = settings.allowedRange;
            document.getElementById('checkinStart').value = settings.checkinTimeStart;
            document.getElementById('checkinEnd').value = settings.checkinTimeEnd;
        }

        // å„²å­˜è¨˜éŒ„ï¼ˆè¨˜æ†¶é«”ä¸­ï¼‰
        function saveRecords() {
            // åœ¨å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œé€™è£¡æœƒå„²å­˜åˆ°å¾Œç«¯è³‡æ–™åº«
            console.log('è¨˜éŒ„å·²å„²å­˜åˆ°è¨˜æ†¶é«”');
        }

        // è¼‰å…¥è¨˜éŒ„ï¼ˆå¾è¨˜æ†¶é«”ï¼‰
        function loadRecords() {
            displayRecords();
        }

        // å®šæœŸæ›´æ–°ä½ç½®ï¼ˆæ¯30ç§’ï¼‰
        setInterval(getCurrentLocation, 30000);
    </script>
</body>
</html>                    

